# ETCD工作原理
ETCD使用Raft协议来维护集群内各个节点状态的一致性。简单说，ETCD集群是一个分布式系统，由多个节点相互通信构成整体对外服务，每个节点都存储了完整的数据，并且通过Raft协议保证每个节点维护的数据是一致的。

## 架构
etcd主要分为四个部分：
- HTTP Server: 用于处理用户发送的API请求以及其他etcd节点的同步与心跳信息请求。
- Store: 用于处理etcd支持的各类功能的事务，包括数据索引、节点状态变更、监控与反馈、事件处理与执行等等，是tecd对用户提供的大多数API功能的具体实现。
- Raft: Raft强一致性算法的具体实现，是etcd的核心。
- WAL: Write Ahead Log(预写式日志)，是etcd的数据存储方式。除了在内存中存有所有数据的状态以及节点的索引以外，etcd就通过WAL进行持久化存储。WAL中，所有的数据提交前都会事先记录日志。Snapshot是为了防止数据过多而进行的状态快照；Entry表示存储的具体日志内容。

> 通常，一个用户的请求发送过来，会经由HTTP Server转发给Store进行具体的事务处理，如果涉及到节点的修改，则交给Raft模块进行状态的变更、日志的记录，然后在同步给别的etcd节点以确认数据提交，最后进行数据的提交，再次同步。

## etcd概念词汇表
- Raft：etcd所采用的保证分布式系统强一致性的算法。
- Node：一个Raft状态机实例。
- Member： 一个etcd实例。它管理着一个Node，并且可以为客户端请求提供服务。
- Cluster：由多个Member构成可以协同工作的etcd集群。
- Client： 向etcd集群发送HTTP请求的客户端。
- Peer：对同一个etcd集群中另外一个Member的称呼。
- WAL：预写式日志，etcd用于持久化存储的日志格式。
- Proxy：etcd的一种模式，为etcd集群提供反向代理服务。
- snapshot：etcd防止WAL文件过多而设置的快照，存储etcd数据状态。
- Leader：Raft算法中通过竞选而产生的处理所有数据提交的节点。
- Follower：竞选失败的节点作为Raft中的从属节点，为算法提供强一致性保证。
- Candidate：当Follower超过一定时间接收不到Leader的心跳时转变为Candidate开始竞选。
- Term：某个节点成为Leader到下一次竞选时间，称为一个Term。
- Index：数据项编号。Raft中通过Term和Index来定位数据。

## 集群化应用
etcd作为一个高可用键值存储系统，天生就是为集群化而设计的。由于Raft算法在做决策时需要多数节点的投票，所以etcd一般部署集群堆推荐基数个节点，推荐的数量为3、5、7等。

###　集群启动
etcd有三种集群化启动方案，分别为静态配置启动、etcd自身服务发现、通过DNS进行服务发现。通过命令行参数或者环境变量的做法来配置参数。

####　静态配置
这种方式适用于离线环境，在启动整个集群之前、就清楚所要配置的集群大小、以及集群上各节点的地址和端口信息。启动时、通过配置initial-cluster参数进行etcd集群的启动。

#### etcd自发现模式
通过自发现的方式启动etcd集群需要事先准备一个集群。如果你本地没有可用的etcd集群，etcd官网提供了一个可以公网访问的etcd存储地址。

#### DNS自发现模式
etcd还支持使用DNS SRV记录进行启动。需要在DNS服务器上进行相应的配置。

### 关键部分源码解析
- etcd的启动是从主目录下的main.go开始的，然后进入etcdmain/etcd.go，载入配置参数。如果配为proxy模式，则进入startProxy函数，否则进入startEtcd,开启etd服务模块和http请求处理模块。

- 在启动http监听时，为了保持与集群其他etcd机器(peers)保持连接，都采用的transport.NewTimeoutListener启动方式，这样在超过指定时间没有获得响应时就会出现超市错误。而在监听client请求时，采用的是transport.NewKeepAliveListener，有助于连接的稳定。

- 在etcdmain/etcd.go中的setupCluste函数可以看到，根据不同etcd的参数、启动集群的方法略有不同，但是最终需要的就是一个IP与端口构成的字符串

- 在静态配置的启动方式中，集群的所有信息都已经给出，所以直接解析用逗号隔开的集群url信息就好了

- 配置etcd过程中通常要用到两种url地址容易混淆，一种用于etcd集群同步信息并保持连接，通常称为peer-urls；另外一种用于接收用户端发来的HTTP请求，通常称为client-urls。

- peer-urls：通常监听的端口为2380，包括所有已经在集群中正常工作的所有节点地址。

- client-urls：通常监听的端口为2379，位适应复杂的网络环境，etcd监听客户端请求的url从原来的1个变为现在可以配置多个。这样etcd可以配合多块网卡同时监听不同网络下的请求。

### 运行时节点变更
etcd集群启动后，可以在运行的过程中对集群进行重构，包括核心节点的增加、删除、迁移、替换等。运行时重构使得etcd集群无须重启即可改变集群的配置。

### 节点迁移、替换
当节点所在的机器出现硬件故障，或者节点数据目录损坏等问题，导致节点永久性的不可恢复时，就需要对节点进行迁移或者替换。迁移一个节点需要进行四步操作：
1. 暂停正在运行着的节点程序进程
2. 把数据目录从现有机器拷贝到新机器
3. 使用api更新etcd中对应节点指向机器的url记录更新为新机器的ip
4. 使用同样的配置项和数据目录，在新的机器上启动etcd

### 节点增加
增加节点可以让etcd集群具有更好的读性能。因为etcd的节点都是实时同步的，每个节点上都存储了所有的信息，所以增加节点可以从整体上提升读的吞吐量。增加一个节点需要进行两步操作：
- 在集群中添加这个节点的url记录，同时获得集群的信息。
- 使用获得的集群信息启动新etcd节点。

### 节点删除
移除节点非常简单，只需要一步操作，就是把集群中这个节点的记录删除。然后对应机器上的该节点就会自动停止。

### 强制性重启集群
当集群超过半数的节点都失效时，就需要通过手动的方式，强制性让某个节点以自己为Leader，利用原有数据启动一个新集群。此时你需要进行两步操作。
- 备份原有数据到新机器。
- 使用-force-new-cluster加备份的数据重新启动节点

> 强制性重启是一个迫不得已的选择，它会破坏一致性协议保证的安全性（如果操作时集群中尚有其它节点在正常工作，就会出错），所以在操作前请务必要保存好数据。

## proxy模式
etcd作为一个反向代理把客户的请求转发给可用的etcd集群。这样，你就可以在每一台机器都部署一个Proxy模式的etcd作为本地服务，如果这些etcd Proxy都能正常运行，那么你的服务发现必然是稳定可靠的。Proxy并不是直接加入到符合强一致性的etcd集群中，也同样的，Proxy并没有增加集群的可靠性，当然也没有降低集群的写入性能。

## 数据存储
- etcd的存储分为内存存储和持久化（硬盘）存储两部分，内存中的存储除了顺序化的记录下所有用户对节点数据变更的记录外，还会对用户数据进行索引、建堆等方便查询的操作。而持久化则使用预写式日志（WAL：Write Ahead Log）进行记录存储。

- 在WAL的体系中，所有的数据在提交之前都会进行日志记录。在etcd的持久化存储目录中，有两个子目录。一个是WAL，存储着所有事务的变化记录；另一个则是snapshot，用于存储某一个时刻etcd所有目录的数据。通过WAL和snapshot相结合的方式，etcd可以有效的进行数据存储和节点故障恢复等操作。

- 既然有了WAL实时存储了所有的变更，为什么还需要snapshot呢？随着使用量的增加，WAL存储的数据会暴增，为了防止磁盘很快就爆满，etcd默认每10000条记录做一次snapshot，经过snapshot以后的WAL文件就可以删除。而通过API可以查询的历史etcd操作默认为1000条。

### 预写式日志
WAL（Write Ahead Log）最大的作用是记录了整个数据变化的全部历程。在etcd中，所有数据的修改在提交前，都要先写入到WAL中。使用WAL进行数据的存储使得etcd拥有两个重要功能。
- 故障快速恢复： 当你的数据遭到破坏时，就可以通过执行所有WAL中记录的修改操作，快速从最原始的数据恢复到数据损坏前的状态。
- 数据回滚（undo）/重做（redo）：因为所有的修改操作都被记录在WAL中，需要回滚或重做，只需要反向或正向执行日志中的操作即可。

###　WAL与snapshot在etcd中的命名规则
- 在etcd的数据目录中，WAL文件以$seq-$index.wal的格式存储。最初始的WAL文件是0000000000000000-0000000000000000.wal，表示是所有WAL文件中的第0个，初始的Raft状态编号为0。运行一段时间后可能需要进行日志切分，把新的条目放到一个新的WAL文件中。

- 假设，当集群运行到Raft状态为20时，需要进行WAL文件的切分时，下一份WAL文件就会变为0000000000000001-0000000000000021.wal。如果在10次操作后又进行了一次日志切分，那么后一次的WAL文件名会变为0000000000000002-0000000000000031.wal。可以看到-符号前面的数字是每次切分后自增1，而-符号后面的数字则是根据实际存储的Raft起始状态来定。

- snapshot的存储命名则比较容易理解，以$term-$index.wal格式进行命名存储。term和index就表示存储snapshot时数据所在的raft节点状态，当前的任期编号以及数据项位置信息。

## Raft算法
### Term任期
Raft中一个Term（任期）是什么意思？ Raft算法中，从时间上，一个任期讲即从一次竞选开始到下一次竞选开始。从功能上讲，如果Follower接收不到Leader节点的心跳信息，就会结束当前任期，变为Candidate发起竞选，有助于Leader节点故障时集群的恢复。发起竞选投票时，任期值小的节点不会竞选成功。如果集群不出现故障，那么一个任期将无限延续下去。而投票出现冲突也有可能直接进入下一任再次竞选。

###　选主
Raft状态机是怎样切换的？ Raft刚开始运行时，节点默认进入Follower状态，等待Leader发来心跳信息。若等待超时，则状态由Follower切换到Candidate进入下一轮term发起竞选，等到收到集群多数节点的投票时，该节点转变为Leader。Leader节点有可能出现网络等故障，导致别的节点发起投票成为新term的Leader，此时原先的老Leader节点会切换为Follower。Candidate在等待其它节点投票的过程中如果发现别的节点已经竞选成功成为Leader了，也会切换为Follower节点。

> https://www.jianshu.com/p/66e2a0cd93d5
